# TUNERL EEG M1 以太网通信协议 #
----------
尝试提交，胡言乱语，吃完饭再改


## 数据帧 ##
数据帧只由采集器向上位机发送
上位机UDP端口7120
专用于接收仪器发送的数据帧

暂缓：设备缓存50ms的数据，上位机监测时间戳的连续性，若出现不连续，通知设备重发

标准以太网数据帧以MTU=1500为设计及测试条件
每个包由前导信息+若干数据样构成（时序采样点）

高精度时间戳精度 1ns  长度 8byte
低精度时间戳精度 10us 长度 4byte 

帧结构如下：
| 帧头 | 前导信息 | 数据样| 帧尾 |
| :----:| :----: | :----: |:----:|
| 1 byte | 123bytes | 单样长度*本帧样数 |1 byte |
| 0xAB | 定长 | 变长 |0xCB|


本例子采用低精度时间戳
设备启动时归零，一个单位代表 10us

帧头
1byte
恒定为 0xAB

前导信息

| 本帧样数| 首样时间戳 | 样间时间戳增量 | 本帧数据格式 |本帧总字节数 | 本帧校验和 |
| :----: | :----: | :----: |:----:|:----:|:----:|
| 1 byte | 4 bytes | 2 bytes |2 bytes |1 byte |
| 定长 | 定长 | 定长 |定长|默认不校验0x00|


本帧样数
1byte
无符号8位整数

本数据帧 数据格式
1byte
其中 约定量化精度16位/24位 占0x80位 0=16位 1=24位

首样时间戳
4byte
无符号32位整数
最大 42949.67296s

样间时间戳增量
2byte
无符号16位整数
最大 655.35ms

本数据帧总字节数
2byte

本数据帧校验和（UDP是否需要应用层校验，是否跟硬件设备有关待研究）
1byte




帧头

数据域
单样长度（byte）= 导联数x约定量化精度字节数 

（每导联单样量化精度为24位3个字节，有符号整型数）
（阻抗测量模式，与平常采样保持一致，有符号整形数，最小位代表1欧姆）



校验和
数据域8位校验和
1 byte


帧尾 
1byte
恒定为 0xCB




注：
采用的单片机是小端（Little Endian）存储方式

例：

8导型号：1 + 1 + 1 + 4 + 3*8 + 2 = 33byte

16导型号：1 + 1 + 1 + 4 + 3*16 + 2 = 57byte


## 标签帧 ##
标签帧独立于数据帧，走数据UDP通道

上位机UDP端口7120，上位机收到标签帧需要应答，超时不应答设备重发

注：标签帧只在“开始采集”工作状态下有效，其他情况下不会主动发出，若接收到按错帧处理



帧头
1byte
恒定为 0xBC

标签时间戳
4byte
无符号32位整数
最大 42949.67296s

标签信息
2byte
16bits 无符号整型数（Little Endian）

本数据帧校验和（UDP是否需要应用层校验，是否跟硬件设备有关待研究）
1byte

帧尾
1byte
恒定为 0xBD
