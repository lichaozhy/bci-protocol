# TUNERL EEG M1 以太网通信协议
----------

#名词定义：

**导联数**：并行采样通道数，只能是8的倍数，每台设备硬件决定 8~256

**大小端**：采用的单片机是小端（Little Endian）存储方式

#以太网端口与服务

##上位机


| 端口号 | 服务名称 | 传输层协议 |
| :----: | :----: | :----: |
| 7120 | 采样数据与标签接收服务 | UDP |


##设备


| 端口号 | 服务名称 | 传输层协议 |
| :----: | :----: | :----: |
| 7121 | 标签帧应答服务 | UDP |


## 数据帧
数据帧只由采集器向上位机发送
目标为上位机UDP端口7120
专用于接收仪器发送的数据帧

暂缓：设备缓存50ms的数据，上位机监测时间戳的连续性，若出现不连续，通知设备重发

标准以太网数据帧以MTU=1500为设计及测试条件
每个包由前导信息+若干数据样构成（时序采样点）

高精度时间戳精度 1ns  长度 8byte
低精度时间戳精度 10us 长度 4byte 

UDP Payload 内帧结构如下：


| 帧头 | 前导信息 | 数据域 | 帧尾 |
| :----: | :----: | :----: |:----:|
| 1 byte | 13 bytes | 单样长度*本帧样数 |1 byte |
| 0xAB | 定长 | 变长 |0xCB|


本例采用低精度时间戳
设备启动时归零，一个单位代表 10us

帧头
1byte
恒定为 0xAB

####前导信息


| 本帧样数| 首样时间戳 | 样间时间戳增量 | 本帧数据格式 |本帧总字节数 | 本帧校验和 |
| :----: | :----: | :----: |:----:|:----:|:----:|
| 1 byte | 4 bytes | 2 bytes |1 byte |2 bytes |1 byte |
| uint8 | uint32 | uint16 | 8 bits | uint16 | uint8 |


本帧样数
1byte
无符号8位整数

本数据帧 数据格式
1byte


| 量化精度| 数据格式 |  保留 | 保留 | 保留 | 保留 | 保留 |
| :----: | :----: | :----: |:----:|:----:|:----:|:----:|
| 1 bit | 2 bit | 1 bit |1 bit | 1 bit | 1 bit |1 bit |


量化精度16位/24位 占0x80 0=16位 1=24位

数据意义 raw/阻抗值 占0x60 0=raw 1=阻抗值 2=温度 3=保留

首样时间戳
4byte
无符号32位整数
最大 42949.67295s

样间时间戳增量
2byte
无符号16位整数
最大 655.35ms

本数据帧总字节数
2byte

本数据帧校验和（UDP是否需要应用层校验，是否跟硬件设备有关待研究）
1byte


####数据域

总数据域长度 = 单样长度 * 本帧样数

单样长度（byte）= 1 + 导联数/8 + 导联数x约定量化精度字节数 

单样结构如下


| 单样隔离字节 | 导联状态 | 导联1 | 导联2 | ... |
| :----: | :----: | :----: |:----:|:----:|
| 1 byte | n bytes | int | int |
| 0xAA | n*8 bits | 量化精度字节数 |量化精度字节数|


这里量化精度24位 3bytes 16位 2bytes 以此类推

导联状态为若干位，32导联有32位 0=导联正常 1=导联失效

导联数据 有符号整型数 24位3字节 16位2字节 32位4字节 按导联编号依次排列

## 标签帧

标签帧独立于数据帧，走数据UDP通道

上位机UDP端口7120，上位机收到标签帧需要应答，超时不应答设备重发

注：标签帧只在“开始采集”工作状态下有效，其他情况下不会主动发出，若接收到按错帧处理

###下位机发送标签帧

帧头
1byte
恒定为 0xBC

标签时间戳
4byte
无符号32位整数
最大 42949.67295s

标签信息
2byte
16bits 无符号整型数（Little Endian）

本数据帧校验和（UDP是否需要应用层校验，是否跟硬件设备有关待研究）
1byte

帧尾
1byte
恒定为 0xBD

###上位机应答帧


| 帧头 | 应答时间戳 | 校验和 | 帧尾 |
| :----: | :----: | :----: |:----:|
| 1 byte | 4 bytes | 1 byte |1 byte |
| 0xEC | uint32 | uint8 | 0xED |


帧头
1byte
恒定为 0xEC

应答标签时间戳
4byte
无符号32位整数
最大 42949.67295s

本数据帧校验和（UDP是否需要应用层校验，是否跟硬件设备有关待研究）
1byte

帧尾
1byte
恒定为 0xED
